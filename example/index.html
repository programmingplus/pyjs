<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyJS Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.10.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.10.0/lib/xterm.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        padding: 20px;
        display: grid;
        row-gap: 10px;
        font-family: "Fira Mono", "DejaVu Sans Mono", Menlo, Consolas, "Liberation Mono", Monaco, "Lucida Console",
          monospace;
        font-size: 14px;
      }

      textarea,
      button,
      .xterm {
        padding: 5px 10px;
        font: inherit;
      }

      textarea {
        height: 5em;
      }
    </style>
  </head>
  <body>
    <textarea id="editor">
name = input("Input your name: ")
print(f"Hello {name}")
</textarea
    >
    <button id="run" type="button">运行</button>
    <div id="terminal"></div>
    <script type="module">
      import * as PyJS from "https://cdn.jsdelivr.net/npm/@programmingplus/pyjs@0.0.4";

      const term = new Terminal();
      term.open(document.getElementById("terminal"));

      const run = document.getElementById("run");
      run.addEventListener("click", async () => {
        term.reset();
        run.disabled = true;
        const write = (s) => void term.write(s.replace(/\n/g, "\r\n"));
        let stdinBuffer = "";
        let resolveStdinBufferPromise;
        let stdinBufferPromise;
        const resetStdinBuffer = () => {
          stdinBuffer = "";
          stdinBufferPromise = new Promise((resolve) => void (resolveStdinBufferPromise = resolve));
        };
        resetStdinBuffer();
        const onDataEvent = term.onData((data) => {
          data = data.replace(/\r\n?/g, "\n");
          write(data);
          stdinBuffer += data;
          if (stdinBuffer) resolveStdinBufferPromise();
        });
        await PyJS.run(document.getElementById("editor").value, {
          writeStdout: write,
          writeStderr: write,
          readStdin: async () => {
            term.focus();
            await stdinBufferPromise;
            const buffer = stdinBuffer;
            resetStdinBuffer();
            return buffer;
          },
        });
        onDataEvent.dispose();
        run.disabled = false;
      });
    </script>
  </body>
</html>
